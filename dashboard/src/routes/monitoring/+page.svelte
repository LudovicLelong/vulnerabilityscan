<script>
  import { onMount, afterUpdate } from 'svelte';
  import { writable, get } from 'svelte/store';
  import { DateTime } from 'luxon';
  import Chart from 'chart.js/auto';

  let apiKey = '';
  let url = '';
  let urlsToAttack = writable([]);
  let alertes = writable([]);
  let currentAlertIndex = writable(0);
  let currentConfidence = writable('high');
  let totalAlerts = writable(0);
  let allAlertsMode = writable(false);

  onMount(() => {
    if (typeof window !== 'undefined') {
      apiKey = localStorage.getItem('apiKey');
      url = localStorage.getItem('url');
      if (localStorage.getItem('urlsToAttack')) {
        urlsToAttack.set(JSON.parse(localStorage.getItem('urlsToAttack')));
      }
      if (localStorage.getItem('alertes')) {
        alertes.set(JSON.parse(localStorage.getItem('alertes')));
      }

      // Initial fetch of high confidence alert
      fetchAlertByConfidence('high');
    }
  });

  const fetchAlertByConfidence = (confidenceLevel) => {
    allAlertsMode.set(false);
    let alerts = get(alertes).filter(alert => alert.confidence.toLowerCase() === confidenceLevel.toLowerCase());
    totalAlerts.set(alerts.length);
    if (alerts.length > 0) {
      currentAlertIndex.set(0);
      showAlertDetails(alerts[0]);
    } else {
      showAlertDetails(null);
    }
  }

  const fetchAllAlerts = () => {
    allAlertsMode.set(true);
    let alerts = get(alertes);
    totalAlerts.set(alerts.length);
    if (alerts.length > 0) {
      currentAlertIndex.set(0);
      showAlertDetails(alerts[0]);
    } else {
      showAlertDetails(null);
    }
  }

  const showAlertDetails = (alert) => {
    if (alert) {
      document.querySelector('.alert-details').innerHTML = `
            <p><strong>URL:</strong> ${alert.url}</p>
            <p><strong>Confiance:</strong> ${alert.confidence}</p>
            <p><strong>Alerte:</strong> ${alert.alert}</p>
            <p><strong>Description:</strong> ${alert.description}</p>
            <p><strong>Solution:</strong> ${alert.solution}</p>
            <p><strong>R√©f√©rence:</strong> ${alert.reference}</p>
        `;
    } else {
      document.querySelector('.alert-details').innerHTML = '<p>Aucune alerte disponible.</p>';
    }
    updateCounter();
  }


  const updateCounter = () => {
    let index = get(currentAlertIndex) + 1;
    let total = get(totalAlerts);
    document.querySelector('.alert-counter').innerText = `Alerte ${index} sur ${total}`;
  }

  const showNextAlert = () => {
    let alerts;
    if (get(allAlertsMode)) {
      alerts = get(alertes);
    } else {
      alerts = get(alertes).filter(alert => alert.confidence.toLowerCase() === get(currentConfidence).toLowerCase());
    }
    let index = get(currentAlertIndex);
    if (index < alerts.length - 1) {
      index++;
      currentAlertIndex.set(index);
      showAlertDetails(alerts[index]);
    }
  }

  const showPrevAlert = () => {
    let alerts;
    if (get(allAlertsMode)) {
      alerts = get(alertes);
    } else {
      alerts = get(alertes).filter(alert => alert.confidence.toLowerCase() === get(currentConfidence).toLowerCase());
    }
    let index = get(currentAlertIndex);
    if (index > 0) {
      index--;
      currentAlertIndex.set(index);
      showAlertDetails(alerts[index]);
    }
  }

  const deleteCurrentAlert = () => {
    let alerts = get(alertes);
    let index = get(currentAlertIndex);
    let alertToDelete;
    if (get(allAlertsMode)) {
      alertToDelete = alerts[index];
    } else {
      alertToDelete = alerts.filter(alert => alert.confidence.toLowerCase() === get(currentConfidence).toLowerCase())[index];
    }
    alerts = alerts.filter(alert => alert !== alertToDelete);
    alertes.set(alerts);
    localStorage.setItem('alertes', JSON.stringify(alerts));
    if (alerts.length > 0) {
      showAlertDetails(alerts[0]);
    } else {
      showAlertDetails(null);
    }
  }

  const setConfidence = (confidence) => {
    currentConfidence.set(confidence);
    fetchAlertByConfidence(confidence);
  }

  const renderCharts = () => {
    const ctx1 = document.getElementById('urlsChart').getContext('2d');
    const ctx2 = document.getElementById('alertsChart').getContext('2d');
    const urlsChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: ['URLs trouv√©es'],
        datasets: [{
          label: 'Nombre de pages URL trouv√©es',
          data: [get(urlsToAttack).length],
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    const alertsData = get(alertes).reduce((acc, alert) => {
      acc[alert.confidence.toLowerCase()]++;
      return acc;
    }, { low: 0, medium: 0, high: 0 });

    const alertsChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: ['Low', 'Medium', 'High'],
        datasets: [{
          label: 'Alertes par niveau de confiance',
          data: [alertsData.low, alertsData.medium, alertsData.high],
          backgroundColor: [
            'rgba(255, 205, 86, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 99, 132, 0.2)'
          ],
          borderColor: [
            'rgba(255, 205, 86, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true
      }
    });
  }

  afterUpdate(() => {
    renderCharts();
  });

</script>



<div class="block-getting-started">
  <div class="mini-bloc-www">
    <p>Getting started - Appuyez n‚Äôimporte o√π sur ce triangle si vous √™tes nouveau √† utiliser l‚Äôoutil</p>
  </div>
  <div class="mini-bloc-www">
    <img class="image-www" src="home/www.png" alt="image en png repr√©sentant un site internet"/>
  </div>
  <div class="mini-bloc-www">
    <p>https:XXXXXXXXXXXXX</p>
  </div>
</div>

<div>

  <h1>Vos statistiques</h1>
</div>


<main>
  <div class="info">
    {#if url && apiKey}
      <p>üîë Votre cl√© API est : {apiKey}</p>
      <p>üåê Vous √™tes en train d'attaquer : {url}</p>
      <br>
    {:else}
      <p>Aucun r√©sultat n'est a affich√©. Lancez un scanner pour obtenir des r√©sultats et des statistiques.</p>
      <br>
    {/if}
  </div>

  <div class="charts-container">
    <div class="chart-box">
      <canvas id="urlsChart"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="alertsChart"></canvas>
    </div>
  </div>


  <div class="alert-details-container">
    <div class="section-title-plus-questionPoint">
      <div>
        <h3 style="text-align: center;font-size: 21px; color: white; ">Traitez les alertes</h3>
      </div>
      <div>
        <div class="interrogation-point">
          <span class="interrogation-letter"><p>?</p></span>
        </div>
      </div>
    </div>


    <div class="alert-counter"></div>

    <div class="alert-controls">
      <button class="blue-background-button" on:click="{() => setConfidence('high')}">üî¥ Alertes Rouges</button>
      <button class="blue-background-button" on:click="{() => setConfidence('medium')}">üü† Alertes Oranges</button>
      <button class="blue-background-button" on:click="{() => setConfidence('low')}">üü¢ Alertes Vertes</button>
      <button class="blue-background-button" on:click="{fetchAllAlerts}">Toutes les alertes</button>

      <button on:click="{deleteCurrentAlert}" class="delete-alert">Supprimer</button>
    </div>


    <div class="alert-details">
      <!-- D√©tails des alertes affich√©s ici -->
    </div>

    <div class="arrow-bloc-main">
        <div class="div-arrow-img-right" on:click="{showPrevAlert}">
          <img class="arrow-img-right" src="monitoring/arrow.png">
        </div>

        <div class="div-arrow-img-left" on:click="{showNextAlert}">
          <img class="arrow-img-left" src="monitoring/arrow.png">
        </div>
    </div>


     <!-- <button on:click="{showPrevAlert}">&laquo; Pr√©c√©dent</button> -->
    <!-- <button on:click="{showNextAlert}">Suivant &raquo;</button> -->
  </div>


</main>

<br>

<footer class="footer">
  <div class="footer-container">
    <div class="footer-section">
      <h4>Docs</h4>
      <ul>
        <li><a href="#">Documentation</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h4>R√©seaux sociaux</h4>
      <ul>
        <li><a href="#">LinkedIn</a></li>
        <li><a href="#">X</a></li>
        <li><a href="#">Reddit</a></li>
        <li><a href="#">YouTube</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h4>Plateformes cyber</h4>
      <ul>
        <li><a href="#">Try Hack Me</a></li>
        <li><a href="#">Hack The Box: LudovicLelong</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h4>More</h4>
      <ul>
        <li><a href="#">GitHub</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <p>Copyright ¬© 2024 Scanner, Inc. Construit avec Ludovic Lelong.</p>
  </div>
</footer>

<br><br>



<style>
/* getting started bloc top */
.block-getting-started {
  display: flex;
  justify-content: center;
  background-image: url("monitoring/getting-started-monitoring.jpg");
  color: white;
  border-radius: 19px;
  font-size: 13px;
  height: 100px;
}

.mini-bloc-www {
  width: 30%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.image-www {
  width: 70px;
}

.info {
  margin-bottom: 20px;
  text-align: start;
}

.charts-container {
  display: flex;
  justify-content: space-around;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 40px;
}

.chart-box {
  display: flex;
  justify-content: center;
  width: 450px;
  height: 300px;
}

#urlsChart {
  min-height: 300px;
}

.alert-details-container {
  background-color: #27496D;
  width: 100%;
  margin-top: 70px;
  margin-bottom: 50px;
  text-align: justify-all;
  border-radius: 15px;
  padding-top: 1px;
}

.alert-counter {
  margin-bottom: 30px;
  font-weight: bold;
  text-align: center;
  color: #C0C0C0;
}

.alert-details {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  margin-bottom: 20px;
  padding: 10px;
  margin-top: 40px;
  color: white;
}

.alert-details p {
  text-align: start;
}

.alert-controls {
  display: flex;
  flex-direction: row;
  justify-content: center;
  flex-wrap: wrap;
  gap: 20px;
}

.blue-background-button {
  background-color: #0A1E2E;
  color: #00A8CC;
}

.alert-controls button {
  border: none;
  border-radius: 50px;
  padding: 10px 20px;
  font-size: 15px;
  cursor: pointer;
  transition: background-color 0.3s, transform 0.3s, color 0.3s;
}

.alert-controls button:hover {
  background-color: #00A8CC;
  color: #0A1E2E;
  transform: scale(1.05);
}

.delete-alert {
  background-color: red;
  color: white;
}

.delete-alert:hover {
  background-color: darkred;
  transform: scale(1.05);
}

.direction-arrow-bloc {
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 20px;
}

/* arrow green */
.arrow-bloc-main {
  display: flex;
  justify-content: center;
 gap: 80px;
  z-index: 1;
}

.arrow-img-right {
  transform: rotate(180deg);
}

.arrow-img-right, .arrow-img-left {
  width: 100px;
}

/* ? on section lecture alertes */

.interrogation-point {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  gap: 13px;
}

.interrogation-point {
  background-color: #0A1E2E;
  width: 40px;
  height: 40px;
  border-radius: 50px;
}

.interrogation-letter {
  color: #00A8CC;
}

.section-title-plus-questionPoint {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 13px;
}

/* footer */
.footer {
  background-color: #27496D;
  border-radius: 13px;
  color: #ffffff;
  padding: 20px 0;
}

.footer-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-around;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.footer-section {
  flex: 1;
  min-width: 200px;
  margin: 10px;
}

.footer-section h4 {
  font-size: 18px;
  margin-bottom: 10px;
}

.footer-section ul {
  list-style-type: none;
  padding: 0;
}

.footer-section ul li {
  margin: 5px 0;
}

.footer-section ul li a {
  color: #C0C0C0;
  text-decoration: none;
}

.footer-section ul li a:hover {
  text-decoration: underline;
}

.footer-bottom {
  text-align: center;
  padding: 10px;
  border-top: 1px solid #C0C0C0;
}

@media (max-width: 768px) {
  .footer-container {
    flex-direction: column;
    align-items: center;
    justify-content: start;
  }

  .footer-section {
    margin: 10px 0;
  }
}



</style>
