<script>
  import { onMount, afterUpdate } from 'svelte';
  import { writable, get } from 'svelte/store';
  import { DateTime } from 'luxon';
  import Chart from 'chart.js/auto';

  let apiKey = '';
  let url = '';
  let urlsToAttack = writable([]);
  let alertes = writable([]);
  let currentAlertIndex = writable(0);
  let currentConfidence = writable('high');
  let totalAlerts = writable(0);
  let allAlertsMode = writable(false);

  onMount(() => {
    if (typeof window !== 'undefined') {
      apiKey = localStorage.getItem('apiKey');
      url = localStorage.getItem('url');
      if (localStorage.getItem('urlsToAttack')) {
        urlsToAttack.set(JSON.parse(localStorage.getItem('urlsToAttack')));
      }
      if (localStorage.getItem('alertes')) {
        alertes.set(JSON.parse(localStorage.getItem('alertes')));
      }

      // Initial fetch of high confidence alert
      fetchAlertByConfidence('high');
    }
  });

  const fetchAlertByConfidence = (confidenceLevel) => {
    allAlertsMode.set(false);
    let alerts = get(alertes).filter(alert => alert.confidence.toLowerCase() === confidenceLevel.toLowerCase());
    totalAlerts.set(alerts.length);
    if (alerts.length > 0) {
      currentAlertIndex.set(0);
      showAlertDetails(alerts[0]);
    } else {
      showAlertDetails(null);
    }
  }

  const fetchAllAlerts = () => {
    allAlertsMode.set(true);
    let alerts = get(alertes);
    totalAlerts.set(alerts.length);
    if (alerts.length > 0) {
      currentAlertIndex.set(0);
      showAlertDetails(alerts[0]);
    } else {
      showAlertDetails(null);
    }
  }

  const showAlertDetails = (alert) => {
    if (alert) {
      document.querySelector('.alert-details').innerHTML = `
        <h3>Détails de l'alerte</h3>
        <p><strong>URL:</strong> ${alert.url}</p>
        <p><strong>Confiance:</strong> ${alert.confidence}</p>
        <p><strong>Alerte:</strong> ${alert.alert}</p>
        <p><strong>Description:</strong> ${alert.description}</p>
        <p><strong>Solution:</strong> ${alert.solution}</p>
        <p><strong>Référence:</strong> ${alert.reference}</p>
      `;
    } else {
      document.querySelector('.alert-details').innerHTML = '<p>Aucune alerte disponible.</p>';
    }
    updateCounter();
  }

  const updateCounter = () => {
    let index = get(currentAlertIndex) + 1;
    let total = get(totalAlerts);
    document.querySelector('.alert-counter').innerText = `Alerte ${index} sur ${total}`;
  }

  const showNextAlert = () => {
    let alerts;
    if (get(allAlertsMode)) {
      alerts = get(alertes);
    } else {
      alerts = get(alertes).filter(alert => alert.confidence.toLowerCase() === get(currentConfidence).toLowerCase());
    }
    let index = get(currentAlertIndex);
    if (index < alerts.length - 1) {
      index++;
      currentAlertIndex.set(index);
      showAlertDetails(alerts[index]);
    }
  }

  const showPrevAlert = () => {
    let alerts;
    if (get(allAlertsMode)) {
      alerts = get(alertes);
    } else {
      alerts = get(alertes).filter(alert => alert.confidence.toLowerCase() === get(currentConfidence).toLowerCase());
    }
    let index = get(currentAlertIndex);
    if (index > 0) {
      index--;
      currentAlertIndex.set(index);
      showAlertDetails(alerts[index]);
    }
  }

  const deleteCurrentAlert = () => {
    let alerts = get(alertes);
    let index = get(currentAlertIndex);
    let alertToDelete;
    if (get(allAlertsMode)) {
      alertToDelete = alerts[index];
    } else {
      alertToDelete = alerts.filter(alert => alert.confidence.toLowerCase() === get(currentConfidence).toLowerCase())[index];
    }
    alerts = alerts.filter(alert => alert !== alertToDelete);
    alertes.set(alerts);
    localStorage.setItem('alertes', JSON.stringify(alerts));
    if (alerts.length > 0) {
      showAlertDetails(alerts[0]);
    } else {
      showAlertDetails(null);
    }
  }

  const setConfidence = (confidence) => {
    currentConfidence.set(confidence);
    fetchAlertByConfidence(confidence);
  }

  const renderCharts = () => {
    const ctx1 = document.getElementById('urlsChart').getContext('2d');
    const ctx2 = document.getElementById('alertsChart').getContext('2d');
    const urlsChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: ['URLs trouvées'],
        datasets: [{
          label: 'Nombre de pages URL trouvées',
          data: [get(urlsToAttack).length],
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    const alertsData = get(alertes).reduce((acc, alert) => {
      acc[alert.confidence.toLowerCase()]++;
      return acc;
    }, { low: 0, medium: 0, high: 0 });

    const alertsChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: ['Low', 'Medium', 'High'],
        datasets: [{
          label: 'Alertes par niveau de confiance',
          data: [alertsData.low, alertsData.medium, alertsData.high],
          backgroundColor: [
            'rgba(255, 205, 86, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 99, 132, 0.2)'
          ],
          borderColor: [
            'rgba(255, 205, 86, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true
      }
    });
  }

  afterUpdate(() => {
    renderCharts();
  });

</script>



<div class="block-getting-started">
  <div class="mini-bloc-www">
    <p>Getting started - Appuyez n’importe où sur ce triangle si vous êtes nouveau à utiliser l’outil</p>
  </div>
  <div class="mini-bloc-www">
    <img class="image-www" src="home/www.png" alt="image en png représentant un site internet"/>
  </div>
  <div class="mini-bloc-www">
    <p>https:XXXXXXXXXXXXX</p>
  </div>
</div>

<main>



  <h1>Page de monitoring</h1>
  <p>Bienvenue sur la page monitoring</p>
</main>


<main>
  <div class="info">
    {#if url && apiKey}
      <p>Votre clé API est : {apiKey}</p>
      <p>Vous êtes en train d'attaquer : {url}</p>
      <p>Voilà vos statistiques :</p>
    {:else}
      <p>Lancez un scanner pour obtenir des résultats.</p>
    {/if}
  </div>

  <div class="charts-container">
    <div class="chart-box">
      <canvas id="urlsChart"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="alertsChart"></canvas>
    </div>
  </div>

  <div class="alert-details-container">
    <div class="alert-counter"></div>
    <div class="alert-details">
      <!-- Détails des alertes affichés ici -->
    </div>
    <div class="alert-controls">
      <button on:click="{() => setConfidence('high')}">Alertes Rouges</button>
      <button on:click="{() => setConfidence('medium')}">Alertes Oranges</button>
      <button on:click="{() => setConfidence('low')}">Alertes Vertes</button>
      <button on:click="{fetchAllAlerts}">Toutes les alertes</button>
      <button on:click="{showPrevAlert}">&laquo; Précédent</button>
      <button on:click="{showNextAlert}">Suivant &raquo;</button>
      <button on:click="{deleteCurrentAlert}" class="delete-alert">Supprimer</button>
    </div>
  </div>
</main>

<style>
  /* getting started bloc top */
  .block-getting-started {
    display: flex;
    justify-content: center;
    background-image: url("monitoring/getting-started-monitoring.jpg");
    color: white;
    border-radius: 19px;
    font-size: 13px;
    height: 100px;
  }

  .mini-bloc-www {
    width: 30%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .image-www {
    width: 70px;
  }

  .info {
    margin-bottom: 20px;
    text-align: center;
  }

  .charts-container {
    display: flex;
    justify-content: space-around;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 40px;
  }

  .chart-box {
    width: 450px;
    height: 300px;

  }

  .alert-details-container {
    width: 100%;
    text-align: center;
  }

  .alert-counter {
    margin-bottom: 10px;
    font-weight: bold;
  }

  .alert-details {
    margin-bottom: 20px;
  }

  .alert-controls button {
    margin: 0 5px;
  }

  .delete-alert {
    background-color: red;
    color: white;
  }
</style>