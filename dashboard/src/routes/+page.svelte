<script>
    import { onMount, afterUpdate } from 'svelte';
    import { writable, get } from 'svelte/store';

    let url = '';
    let apiKey = '';
    let results = writable([]);
    let statusMessages = writable([]);
    let urlsToAttack = writable([]);
    let terminalBody;
    let searchPerformed = false;
    let scanId = '';
    let emergencyStop = false;
    let loading = writable(false); // Indicateur de chargement

    // Redéfinir fetch pour intercepter les appels API pour emergency stop
    if (typeof window !== 'undefined') {
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            if (emergencyStop && args[0].startsWith('http://localhost:8082/')) {
                console.log('Arrêt d\'urgence activé. Appel API interrompu.');
                return new Response(JSON.stringify({ message: 'Arrêt d\'urgence activé.' }), {
                    status: 503,
                    headers: { 'Content-Type': 'application/json' }
                });
            }
            return originalFetch(...args);
        };
    }

    // Récupérer les données depuis le localStorage lors du chargement de la page
    onMount(() => {
        const storedUrls = localStorage.getItem('urlsToAttack');
        const storedFlag = localStorage.getItem('searchPerformed');
        const storedUrl = localStorage.getItem('url');
        const storedApiKey = localStorage.getItem('apiKey');

        if (storedUrls) {
            urlsToAttack.set(JSON.parse(storedUrls));
        }

        if (storedFlag) {
            searchPerformed = JSON.parse(storedFlag);
        }

        if (storedUrl) {
            url = storedUrl;
        }

        if (storedApiKey) {
            apiKey = storedApiKey;
        }
    });

    // Stocker les URLs et le flag dans localStorage à chaque mise à jour
    urlsToAttack.subscribe(value => {
        if (searchPerformed) {
            localStorage.setItem('urlsToAttack', JSON.stringify(value));
        }
    });

    async function checkApiStatus() {
        try {
            const response = await fetch('http://localhost:8082/status');
            return response.ok;
        } catch (error) {
            return false;
        }
    }

    async function handleSubmit() {
        console.log('Starting search...');
        statusMessages.set([]);
        results.set([]);
        searchPerformed = true;
        localStorage.setItem('searchPerformed', JSON.stringify(searchPerformed));

        // Stocker l'URL et la clé API dans le localStorage
        localStorage.setItem('url', url);
        localStorage.setItem('apiKey', apiKey);

        const apiAvailable = await checkApiStatus();
        if (!apiAvailable) {
            statusMessages.update(messages => [...messages, 'API du scanner pas allumé']);
            return;
        }

        loading.set(true); // Début du chargement

        const requestUrl = 'http://localhost:8082/start-spider-scan';
        statusMessages.update(messages => [...messages, `Request URL: ${requestUrl}`]);

        try {
            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ api_key: apiKey, target: url })
            });

            if (!response.ok) {
                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            scanId = data.scan_id;
            statusMessages.update(messages => [...messages, `Response: ${JSON.stringify(data)}`]);

            if (data.results && data.results.length > 0) {
                urlsToAttack.set(data.results);
            }

            // getStatus();
        } catch (err) {
            statusMessages.update(messages => [...messages, `Erreur: ${err.message}`]);
        } finally {
            loading.set(false); // Fin du chargement
        }
    }

    async function getStatus() {
        const interval = setInterval(async () => {
            const requestUrl = `http://localhost:8082/spider/status?scanId=${scanId}`;
            statusMessages.update(messages => [...messages, `Request URL: ${requestUrl}`]);

            try {
                const response = await fetch(requestUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                statusMessages.update(messages => [...messages, `Response: ${JSON.stringify(data)}`]);

                const progress = data.status;
                statusMessages.update(messages => [...messages, `Spider status: ${progress}%`]);

                if (progress >= 100) {
                    clearInterval(interval);
                    statusMessages.update(messages => [...messages, 'Scan complete']);
                    getResults();
                }
            } catch (err) {
                statusMessages.update(messages => [...messages, `Erreur: ${err.message}`]);
                clearInterval(interval);
            }
        }, 2000);
    }

    async function getResults() {
        const requestUrl = `http://localhost:8082/spider/results?scanId=${scanId}`;
        statusMessages.update(messages => [...messages, `Request URL: ${requestUrl}`]);

        try {
            const resultsResponse = await fetch(requestUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': apiKey
                }
            });

            if (!resultsResponse.ok) {
                throw new Error(`Erreur ${resultsResponse.status}: ${resultsResponse.statusText}`);
            }

            const resultsData = await resultsResponse.json();
            results.set(resultsData.results);
            statusMessages.update(messages => [...messages, `Response: ${JSON.stringify(resultsData)}`]);

            if (resultsData.results && resultsData.results.length > 0) {
                urlsToAttack.set(resultsData.results);
            }
        } catch (err) {
            statusMessages.update(messages => [...messages, `Erreur: ${err.message}`]);
        }
    }

    function formatAttackResult(data, target) {
        return data.results.map(result => {
            return {
                url: target,
                confidence: result.confidence,
                alert: result.alert,
                description: result.description,
                solution: result.solution,
                reference: result.reference
            };
        });
    }

    async function handleAttack() {
        const apiAvailable = await checkApiStatus();
        const lastMessage = getLastMessage();

        if (!apiAvailable) {
            if (lastMessage !== 'API du scanner pas allumé') {
                statusMessages.update(messages => [...messages, 'API du scanner pas allumé']);
            }
            return;
        }

        const $urlsToAttack = get(urlsToAttack);
        if ($urlsToAttack.length === 0) {
            statusMessages.update(messages => [...messages, 'Aucune URL à attaquer. Veuillez d\'abord lancer la recherche.']);
            return;
        }

        const requestUrl = 'http://localhost:8082/start-active-scan';
        statusMessages.update(messages => [...messages, `Request URL: ${requestUrl}`]);

        try {
            for (const target of $urlsToAttack) {
                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: apiKey, target_for_active_scan: target })
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                statusMessages.update(messages => [...messages, `Response for ${target}: ${JSON.stringify(data)}`]);

                if (data.results) {
                    const formattedResults = formatAttackResult(data, target);
                    results.update(currentResults => [...currentResults, ...formattedResults]);
                    localStorage.setItem('alertes', JSON.stringify(formattedResults));
                }
            }
        } catch (err) {
            statusMessages.update(messages => [...messages, `Erreur: ${err.message}`]);
        }
    }

    function getLastMessage() {
        let lastMessage = '';
        statusMessages.update(messages => {
            lastMessage = messages[messages.length - 1];
            return messages;
        });
        return lastMessage;
    }

    function handleEmergencyStop() {
        emergencyStop = true;
        statusMessages.update(messages => [...messages, 'Arrêt d\'urgence activé.']);
    }

    afterUpdate(() => {
        if (terminalBody) {
            terminalBody.scrollTop = terminalBody.scrollHeight;
        }
    });
</script>






















<div class="block-getting-started">
    <div class="mini-bloc-www">
        <p>Getting started - Appuyez n’importe où sur ce triangle si vous êtes nouveau à utiliser l’outil</p>
    </div>
    <div class="mini-bloc-www">
        <img class="image-www" src="home/www.png" alt="image en png représentant un site internet"/>
    </div>
    <div class="mini-bloc-www">
        <p>https:XXXXXXXXXXXXX</p>
    </div>
</div>

<br>
<h2>Explorer le monde de demain</h2>

<div class="bloc-principal-command">
    <div class="block-color-blue-sections">
        <div class="align-center">
            <span class="letter-number"><h3>1</h3></span>
        </div>

        <div class="bloc-left-align bloc-left-align-intero-plus">
            <div>
                <h4>Récupérer points d’attaques</h4>
            </div>
            <div>
                <div class="interrogation-point">
                    <span class="interrogation-letter"><p>?</p></span>
                </div>
            </div>
        </div>

        <div class="align-center">
            <span class="grey-text-bellow-intero"><p>Veuillez taper l’url d’entrée que vous possédez. </p></span>
        </div>

        <div class="align-center">
            <img src="home/metro-enter.png" alt="Montre une photo d'un portique d'entrée d'une bouche de métro" />
        </div>

        <main class="main-content">
            <form on:submit|preventDefault={handleSubmit}>
                <div class="bloc-left-align">
                    <div class="align-word-input">
                        <div class="label">
                            <p>URL :</p>
                        </div>
                        <div>
                            <div>
                                <input type="text" id="url" bind:value={url} required minlength="4" size="10" placeholder="Taper ici" />
                            </div>
                        </div>
                    </div>

                    <div class="align-word-input">
                        <div class="label">
                            <p>Votre clé API :</p>
                        </div>
                        <div>
                            <div>
                                <input type="text" id="apiKey" bind:value={apiKey} required minlength="4" size="10" placeholder="Taper ici" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="align-center">
                    <button type="submit" class="validate-button-div">
                        <span class="validate-button-word"><p>Lancer la recherche</p></span>
                    </button>
                </div>
            </form>
        </main>
    </div>

    <div>
        <img src="home/arrow.png" alt="Flèche de transition"/>
    </div>

    <div class="block-color-blue-sections">
        <div class="align-center">
            <span class="letter-number"><h3>2</h3></span>
        </div>

        <div class="bloc-left-align bloc-left-align-intero-plus">
            <div>
                <h4>Attaquer</h4>
            </div>
            <div>
                <div class="interrogation-point">
                    <span class="interrogation-letter"><p>?</p></span>
                </div>
            </div>
        </div>

        <div class="align-center">
            <span class="grey-text-bellow-intero"><p>Ce scan va lancer plusieurs types <br> d’attaque, notamment : </p></span>
        </div>

        <div class="checkbox-container">
            <div class="checkbox-item">

               <div id="sql-injection"><img src="home/inj-sql.png" style="width: 40px"></div>
               <!--  <input type="checkbox" id="sql-injection" name="sql-injection"> -->
                <label for="sql-injection">Injection SQL</label>
            </div>
            <div class="checkbox-item">
                <div id="sql-injection"><img src="home/xss-attack.png" style="width: 40px"></div>
                <!-- <input type="checkbox" id="access-control" name="access-control"> -->
                <label for="access-control">Cross-Site Scripting</label>
            </div>
            <div class="checkbox-item">
                <div id="sql-injection"><img src="home/security-misconfiguration.png" style="width: 40px"></div>
                <!-- <input type="checkbox" id="session-management" name="session-management"> -->
                <label for="session-management">Security Misconfiguration</label>
            </div>
            <div class="checkbox-item">
                <div id="sql-injection"><img src="home/data-exposure.png" style="width: 40px"></div>
                <!--  <input type="checkbox" id="use-all" name="use-all"> -->
                <label for="use-all">Sensitive Data Exposure</label>
            </div>
        </div>

        <div class="align-center">
            <button type="button" class="validate-button-div" style="margin-top: 16px" on:click={handleAttack}>
                <span class="validate-button-word"><p>Lancer l’attaque</p></span>
            </button>
        </div>
    </div>
</div>
<br>
<h2>Les résultats</h2>

<div class="terminal">
    <div class="terminal-header">
        <div class="terminal-buttons">
            <span class="red-button"></span>
            <span class="yellow-button"></span>
            <span class="green-button"></span>
        </div>
        <div class="terminal-title">
            <span><img src="home/icon-administrator.png" alt="icon" class="terminal-icon"></span>
        </div>
    </div>
    <!-- <div class="terminal-body" bind:this={terminalBody} on:scroll={handleScroll}  > -->
    <div class="terminal-body" bind:this={terminalBody} >
        <p>19/07/2024 &emsp; 17:22 PM &emsp; Aucune action n’a été lancée pour le moment.</p>
        {#each $statusMessages as message}
            <p>{message}</p>
        {/each}
        {#each $results as result}
            <!-- <p>{JSON.stringify(result)}</p> -->
            <div class="height-url-for-section">
                <p><span class="bold-title">URL:</span> {result.url}</p>
            </div>
            <p><span class="bold-title">Confidence:</span> {result.confidence}</p>
            <p><span class="bold-title">Alert:</span> {result.alert}</p>
            <p><span class="bold-title">Description:</span> {result.description}</p>
            <p><span class="bold-title">Solution:</span> {result.solution}</p>
            <p><span class="bold-title">Reference:</span> {result.reference}</p>
        {/each}
        {#if $loading}
            <p>Travail en cours<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></p>
        {/if}
        <!-- <p>Voila les URL stockées: {JSON.stringify($urlsToAttack)}</p> <!-- To delete at the end just console pour voir ca les url sont bien stockées -->
    </div>
</div>

<br>

<div class="emergency-stop">
    <button on:click={handleEmergencyStop}>Arrêt d'urgence du terminal</button>
</div>

<br>


<style>
    /* getting started bloc top */
    /* old : background-color: #0A1E2E; remplacment background-image */
    .block-getting-started {
        display: flex;
        justify-content: center;
        background-image: url("https://www.codewithrandom.com/wp-content/uploads/2023/04/Copy-of-codewithrandom11.png");
        color: white;
        border-radius: 19px;
        font-size: 13px;
        height: 100px;
    }

    .mini-bloc-www {
        width: 30%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .image-www {
        width: 70px;
    }

    .bloc-principal-command {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 120px;
    }

    @media (max-width: 1380px) {
        .bloc-principal-command {
            gap: 40px;
        }
    }

    @media (max-width: 1200px) {
        .bloc-principal-command {
            gap: 20px;
        }
    }

    @media (max-width: 1189px) {
        .bloc-principal-command {
            flex-direction: column;
        }
    }

    .bloc-left-align,
    .interrogation-point,
    .validate-button-div {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 13px;
    }

    .bloc-left-align {
        flex-direction: column;
    }

    .bloc-left-align-intero-plus {
        flex-direction: row;
    }

    .align-center {
        display: flex;
        justify-content: center;
        text-align: center;
    }

    .interrogation-point {
        background-color: #0A1E2E;
        width: 40px;
        height: 40px;
        border-radius: 50px;
    }

    .interrogation-letter {
        color: #00A8CC;
    }

    .letter-number {
        font-size: 35px;
        color: #00A8CC;
    }

    #taper-ici {
        height: 20px;
        width: 220px;
    }

    .validate-button-div {
        background-color: #0A1E2E;
        width: 160px;
        border-radius: 50px;
        margin-bottom: 20px;
        border: none;
    }

    .validate-button-word {
        font-size: 15px;
        color: #00A8CC;
    }

    .align-word-input {
        display: flex;
        justify-content: flex-start;
        flew-direction: row;
        align-items: center;
        gap: 10px;
    }

    .label {
        width: 100px;
        text-align: right;
        margin-right: 10px;
    }

    .grey-text-bellow-intero {
        color: #C0C0C0;
    }

    /* multi selection case */
    .checkbox-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-left: 68px;
        gap: 10px;
    }

    label {
        color: white;
        font-weight: bold;
    }

    /* block sections for the two */
    .block-color-blue-sections {
        background-color: #27496D;
        border-radius: 13px;
        width: 380px;
    }

    /* style terminal */
    body {
        font-family: Arial, sans-serif;
    }

    .terminal {
        max-width: 100%;
        background-color: #d3d3d3;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .terminal-header {
        background-color: #000;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 10px;
    }

    .terminal-buttons {
        display: flex;
        gap: 5px;
    }

    .terminal-buttons span {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .red-button {
        background-color: #ff5f56;
    }

    .yellow-button {
        background-color: #ffbd2e;
    }

    .green-button {
        background-color: #27c93f;
    }

    .terminal-title {
        display: flex;
        align-items: center;
    }

    .terminal-body {
        padding: 15px;
        background-color: #e0e0e0;
        max-height: 600px;
        overflow-y: auto;
    }

    .terminal-body p {
        margin: 0;
        padding: 5px 0;
    }

    @media (max-width: 768px) {
        .terminal-body {
            font-size: 14px;
        }
    }

    @media (max-width: 480px) {
        .terminal-body {
            font-size: 12px;
        }
    }

    /* Animation des points pour l'indicateur de chargement */
    @keyframes dot-blink {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }

    .dot {
        display: inline-block;
        font-size: 24px;
        animation: dot-blink 1s infinite;
    }

    .dot:nth-child(1) {
        animation-delay: 0s;
    }

    .dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    /* title attack result form */

    .bold-title {
        font-weight: bold;
    }

    .height-url-for-section {
        margin-top: 23px;
    }


</style>
