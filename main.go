package main

import (
	"fmt"
	"vulnerabilityscan/zap-ajax-spider"
)

func main() {
	zap := ajax_spider.NewZAPv2()

	// Essayez de démarrer un nouveau scan
	scanID, err := zap.AjaxSpiderScan()
	if err != nil {
		// Vérifiez si l'erreur est due à un scan déjà en cours
		if err.Error() == "scan in progress" {
			fmt.Println("En attente de la fin du scan en cours...")

			// Attendre la fin du scan en cours
			err = zap.WaitForScanToComplete("1") // Supposons que l'ID du scan en cours est "1". Mettez l'ID correct ici si disponible.
			if err != nil {
				fmt.Printf("Erreur lors de l'attente de la fin du scan: %v\n", err)
				return
			}

			// Démarrer un nouveau scan après que l'ancien soit terminé
			fmt.Println("Démarrage d'un nouveau scan...")
			scanID, err = zap.AjaxSpiderScan()
			if err != nil {
				fmt.Printf("Erreur lors du démarrage de l'AJAX Spider: %v\n", err)
				return
			}
		} else {
			fmt.Printf("Erreur lors du démarrage de l'AJAX Spider: %v\n", err)
			return
		}
	}

	fmt.Printf("Scan démarré avec l'ID: %s\n", scanID)

	// Vérifier le statut immédiatement après le démarrage
	status, progress, err := zap.AjaxSpiderStatus(scanID)
	if err != nil {
		fmt.Printf("Erreur lors de la vérification du statut du scan: %v\n", err)
		return
	}

	fmt.Printf("Statut initial du scan: %s, progression: %s%%\n", status, progress)

	// Attendre la fin du scan
	if err := zap.WaitForScanToComplete(scanID); err != nil {
		fmt.Printf("Erreur lors de l'attente de la fin du scan: %v\n", err)
		return
	}

	fmt.Println("Scan terminé")

	// Récupérer les résultats du scan
	results, err := zap.AjaxSpiderResults(0, 100)
	if err != nil {
		fmt.Printf("Erreur lors de la récupération des résultats: %v\n", err)
		return
	}

	// Stocker les URLs dans un tableau
	var urls []string
	for _, result := range results {
		urls = append(urls, result.URL)
	}

	// Afficher les URLs trouvées
	fmt.Println("URLs trouvées par le scan AJAX:")
	for _, url := range urls {
		fmt.Println(url)
	}

	// Retourner les URLs sous forme de tableau
	fmt.Println("Tableau des URLs trouvées:")
	fmt.Println(urls)
}
