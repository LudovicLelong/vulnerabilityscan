---
sidebar_position: 2
title: "Utiliser spider classique pour trouver toutes les urls associées qu'il y a sur une page internet"
---


## Le code besoin dans le main pour lancer l'analyse 

Je vous donne ici le code pour que ca marche en local sans pour l'instant parler d'API, qu'il y aura après et qui nous servira de communiquer entre notre front (site visuel) et le back.

```
package main

import (
	"fmt"
	"time"
	"vulnerabilityscan/zap-spider-url"
)

func main() {
	zapClient := zap_spider_url.NewZAPv2()

	fmt.Printf("Spider target %s\n", zap_spider_url.Target)

	// Utiliser le Traditional Spider Scan
	scanID, err := zapClient.SpiderScan()
	if err != nil {
		fmt.Println("Erreur lors du démarrage du Traditional Spider:", err)
		return
	}
	fmt.Printf("Scan ID: %s\n", scanID)

	timeout := time.Now().Add(2 * time.Minute)
	for {
		status, err := zapClient.SpiderStatus(scanID)
		if err != nil {
			fmt.Println("Erreur lors de la vérification du statut du Spider:", err)
			return
		}
		if status == "100" { // Vérifiez si le Spider est à 100%
			fmt.Println("Spider a terminé à 100%")
			break
		}
		if time.Now().After(timeout) {
			fmt.Println("Timeout atteint")
			break
		}
		fmt.Printf("Spider status: %s%%\n", status) // Affiche le pourcentage de progression
		time.Sleep(2 * time.Second)
	}

	fmt.Println("Spider completed")
	results, err := zapClient.SpiderResults(0, 100)
	if err != nil {
		fmt.Println("Erreur lors de l'obtention des résultats du Spider:", err)
		return
	}

	fmt.Printf("Nombre de résultats du Spider: %d\n", len(results))
	fmt.Println("Spider results:", results)
}

```

et le fichier spider.go : 

```
package zap_spider_url

import (
	"encoding/json"
	"fmt"
	"net/url"
)

func (zap *ZAPv2) SpiderScan() (string, error) {
	params := url.Values{}
	params.Add("url", Target)

	body, err := zap.Request("/JSON/spider/action/scan/", params)
	if err != nil {
		return "", err
	}

	fmt.Println("Response from Traditional Spider Scan:", string(body)) // Log supplémentaire

	var result map[string]interface{}
	if err := json.Unmarshal(body, &result); err != nil {
		return "", err
	}

	scanID, ok := result["scan"].(string)
	if !ok {
		return "", fmt.Errorf("failed to start traditional spider scan")
	}

	return scanID, nil
}

func (zap *ZAPv2) SpiderStatus(scanID string) (string, error) {
	params := url.Values{}
	params.Add("scanId", scanID)

	body, err := zap.Request("/JSON/spider/view/status/", params)
	if err != nil {
		return "", err
	}

	fmt.Println("Response from Spider Status:", string(body)) // Log supplémentaire

	var status SpiderStatus
	if err := json.Unmarshal(body, &status); err != nil {
		return "", err
	}

	return status.Status, nil
}

func (zap *ZAPv2) SpiderResults(start, count int) ([]string, error) { // Changer le type de retour ici
	params := url.Values{}
	params.Add("start", fmt.Sprintf("%d", start))
	params.Add("count", fmt.Sprintf("%d", count))

	body, err := zap.Request("/JSON/spider/view/results/", params)
	if err != nil {
		return nil, err
	}

	fmt.Println("Response from Spider Results:", string(body)) // Log supplémentaire

	var results SpiderResults
	if err := json.Unmarshal(body, &results); err != nil {
		return nil, err
	}

	return results.Results, nil // Changer le type de retour ici
}

```

et pour zap.go : 
```
package zap_spider_url

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"net/http"
	"net/url"
	"time"
)

const (
	ApiKey     = "mh20la1c8igrtk0h6ovbd5evtl"
	ZapBaseURL = "http://localhost:8082"
	Target     = "https://public-firing-range.appspot.com"
)

type ZAPv2 struct {
	APIKey  string
	BaseURL string
	Client  *http.Client
}

func NewZAPv2() *ZAPv2 {
	return &ZAPv2{
		APIKey:  ApiKey,
		BaseURL: ZapBaseURL,
		Client:  &http.Client{},
	}
}

func (zap *ZAPv2) Request(endpoint string, params url.Values) ([]byte, error) {
	params.Add("apikey", zap.APIKey)
	fullURL := fmt.Sprintf("%s%s?%s", zap.BaseURL, endpoint, params.Encode())

	fmt.Printf("Request URL: %s\n", fullURL) // Log supplémentaire

	resp, err := zap.Client.Get(fullURL)
	if err != nil {
		return nil, err
	}
	defer resp.Body.Close()

	return ioutil.ReadAll(resp.Body)
}

func (zap *ZAPv2) ActiveScan(target string) (string, error) {
	params := url.Values{}
	params.Add("url", target)

	body, err := zap.Request("/JSON/ascan/action/scan/", params)
	if err != nil {
		return "", err
	}

	fmt.Println("Response from Active Scan:", string(body)) // Log supplémentaire

	var result map[string]interface{}
	if err := json.Unmarshal(body, &result); err != nil {
		return "", err
	}

	scanID, ok := result["scan"].(string)
	if !ok {
		return "", fmt.Errorf("failed to start active scan")
	}

	return scanID, nil
}

func (zap *ZAPv2) ScanStatus(scanID string) (string, error) {
	params := url.Values{}
	params.Add("scanId", scanID)

	body, err := zap.Request("/JSON/ascan/view/status/", params)
	if err != nil {
		return "", err
	}

	var result map[string]interface{}
	if err := json.Unmarshal(body, &result); err != nil {
		return "", err
	}

	return fmt.Sprintf("%v", result["status"]), nil
}

func (zap *ZAPv2) Alerts(baseurl string) ([]map[string]interface{}, error) {
	params := url.Values{}
	params.Add("baseurl", baseurl)

	body, err := zap.Request("/JSON/core/view/alerts/", params)
	if err != nil {
		return nil, err
	}

	var result map[string]interface{}
	if err := json.Unmarshal(body, &result); err != nil {
		return nil, err
	}

	alerts, ok := result["alerts"].([]interface{})
	if !ok {
		return nil, fmt.Errorf("failed to retrieve alerts")
	}

	alertsMap := make([]map[string]interface{}, len(alerts))
	for i, alert := range alerts {
		alertsMap[i] = alert.(map[string]interface{})
	}

	return alertsMap, nil
}

func (zap *ZAPv2) WaitForScanToComplete(scanID string) error {
	for {
		status, err := zap.ScanStatus(scanID)
		if err != nil {
			return err
		}

		if status == "100" {
			break
		}

		fmt.Printf("Scan ID: %s, Progress: %s%%\n", scanID, status)
		time.Sleep(5 * time.Second)
	}
	return nil
}

```




Pour que ca marche il faut changer dans . > zap-spider-url > zap :
!["Image de code pour remplir zap api key"](./img/zap-apikey-field.png)
Remplir et mettre sa bonne clé d'API, son bon numéro de port localhost, et le site internet ("Target") dont on veut trouver tous ces liens.

Quand on lance le résultat on tombe sur un tableau avec toutes les url trouvé sur la page : 
!["Tableau résultat spider"](./img/tableau-resultat.png)

Pour allé plus loin : [Utiliser spider Ajax](spider-ajax.md) .